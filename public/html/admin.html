<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin | Nova Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar scrolled">
    <div class="nav-content">
        <div class="logo">NOVA STORE <span style="color:var(--secondary); font-size:0.8em;">ADMIN</span></div>
        <ul class="nav-links">
            <li><a href="/">Ir a Tienda</a></li>
            <li><a href="/auth/logout" class="btn-nav">Cerrar Sesión</a></li>
        </ul>
    </div>
</nav>

<section class="admin-container">
    <div class="admin-header">
        <h2>Panel de Control</h2>
        <p>Administra tu negocio desde un solo lugar</p>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" onclick="cargarVista('clientes')">
            <i class="fa-solid fa-users"></i> Clientes
        </button>
        <button class="tab-btn" onclick="cargarVista('vendedores')">
            <i class="fa-solid fa-user-tie"></i> Vendedores
        </button>
        <button class="tab-btn" onclick="cargarVista('productos')">
            <i class="fa-solid fa-box-open"></i> Productos
        </button>
    </div>

    <div class="table-container">
        
        <div id="action-bar" class="action-bar"></div>

        <table class="data-table">
            <thead id="table-head">
                </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</section>

<script>
    // Variables globales
    let vistaActual = 'clientes';
    let usuarioSeleccionadoId = null; // Para saber a quién estamos editando

    // Función principal que controla qué ver
    async function cargarVista(vista) {
        vistaActual = vista;
        limpiarFormulario(); // Limpiamos selección al cambiar de pestaña
        
        // 1. Actualizar estilo de botones (Tabs)
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if(event && event.target) {
            const btn = event.target.closest('button');
            if(btn) btn.classList.add('active');
        }

        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const actionBar = document.getElementById('action-bar');
        
        // Limpiar tabla y mostrar carga
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Cargando datos...</td></tr>';
        actionBar.innerHTML = ''; 

        try {
            if (vista === 'clientes' || vista === 'vendedores') {
                // Definir el rol actual
                const rol = vista === 'clientes' ? 'cliente' : 'vendedor';

                // --- NUEVO: Formulario con BOTONES DE ACTUALIZAR ---
                actionBar.innerHTML = `
                    <div class="inline-form">
                        <input id="uNombre" placeholder="Nombre completo" />
                        <input id="uEmail" placeholder="Correo electrónico" />
                        <input id="uPass" type="password" placeholder="Contraseña" />
                        
                        <button class="btn-primary" onclick="crearUsuario('${rol}')">+ Agregar</button>
                        
                        <button id="btnUpdate" class="btn-primary" onclick="actualizarUsuario()" style="display:none; background-color: #f59e0b; margin-left:5px;">Actualizar</button>
                        <button id="btnCancel" class="btn-delete" onclick="limpiarFormulario()" style="display:none; margin-left:5px;">Cancelar</button>
                    </div>
                `;

                // Configurar Encabezados
                const extraHeader = vista === 'vendedores' ? 'Ventas' : 'Rol';
                tableHead.innerHTML = `
                    <tr>
                        <th>ID</th><th>Nombre</th><th>Email</th><th>${extraHeader}</th><th>Acciones</th>
                    </tr>
                `;

                // Obtener datos
                const res = await fetch(`/admin/users?rol=${rol}`);
                const data = await res.json();
                renderUsers(data);

            } else if (vista === 'productos') {
                // --- Formulario Productos ---
                actionBar.innerHTML = `
                    <div class="inline-form">
                        <input id="pNombre" placeholder="Nombre" />
                        <input id="pDesc" placeholder="Descripción" />
                        <input id="pPrecio" type="number" placeholder="$" style="width:80px;" />
                        <button class="btn-primary" onclick="crearProducto()">+ Agregar</button>
                    </div>
                `;

                tableHead.innerHTML = `<tr><th>ID</th><th>Imagen</th><th>Producto</th><th>Descripción</th><th>Precio</th><th>Acciones</th></tr>`;
                const res = await fetch('/products');
                const data = await res.json();
                renderProducts(data);
            }
        } catch (error) {
            console.error(error);
            tableBody.innerHTML = '<tr><td colspan="5">Error al cargar datos</td></tr>';
        }
    }

    // Renderizar Usuarios (Con evento CLICK para editar)
    function renderUsers(users) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        
        if(users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay registros</td></tr>';
            return;
        }

        users.forEach(u => {
            // Convertimos el usuario a texto para pasarlo a la función, evitando error con comillas simples
            const userStr = JSON.stringify(u).replace(/'/g, "&#39;");

            tbody.innerHTML += `
                <tr onclick='seleccionarUsuario(${userStr})' style="cursor: pointer; transition: 0.2s;" title="Clic para editar">
                    <td>#${u.id}</td>
                    <td><div class="user-cell"><strong>${u.nombre}</strong></div></td>
                    <td>${u.email}</td>
                    <td><span class="badge ${u.rol}">${u.rol}</span></td>
                    <td>
                        <button class="btn-delete" onclick="event.stopPropagation(); eliminarUsuario(${u.id})">Eliminar</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- NUEVAS FUNCIONES PARA EDICIÓN ---

    // 1. Rellenar inputs al hacer clic
    function seleccionarUsuario(user) {
        usuarioSeleccionadoId = user.id; // Guardamos el ID

        // Llenamos los campos
        document.getElementById('uNombre').value = user.nombre;
        document.getElementById('uEmail').value = user.email;
        
        // La contraseña la limpiamos (no la mostramos por seguridad)
        const passField = document.getElementById('uPass');
        passField.value = '';
        passField.placeholder = "Nueva contraseña (o dejar vacío)";

        // Mostramos botones de edición
        document.getElementById('btnUpdate').style.display = 'inline-block';
        document.getElementById('btnCancel').style.display = 'inline-block';
    }

    // 2. Limpiar formulario y ocultar botones de edición
    function limpiarFormulario() {
        usuarioSeleccionadoId = null;
        if(document.getElementById('uNombre')) {
            document.getElementById('uNombre').value = '';
            document.getElementById('uEmail').value = '';
            document.getElementById('uPass').value = '';
            document.getElementById('uPass').placeholder = "Contraseña";
            
            // Ocultar botones extra
            document.getElementById('btnUpdate').style.display = 'none';
            document.getElementById('btnCancel').style.display = 'none';
        }
    }

    // 3. Enviar actualización al servidor
    async function actualizarUsuario() {
        if(!usuarioSeleccionadoId) return alert("Selecciona un usuario primero");

        const nombre = document.getElementById('uNombre').value;
        const email = document.getElementById('uEmail').value;
        const password = document.getElementById('uPass').value;
        // Mantenemos el rol de la vista actual
        const rol = vistaActual === 'clientes' ? 'cliente' : 'vendedor';

        try {
            const res = await fetch('/admin/users/' + usuarioSeleccionadoId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nombre, email, password, rol })
            });

            if(res.ok) {
                alert("Usuario actualizado correctamente");
                limpiarFormulario(); // Reseteamos
                cargarVista(vistaActual); // Recargamos tabla
            } else {
                alert("Error al actualizar");
            }
        } catch (e) {
            console.error(e);
            alert("Error de conexión");
        }
    }

    // --- FIN FUNCIONES DE EDICIÓN ---

    // Renderizar Productos
    function renderProducts(products) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        products.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>#${p.id}</td>
                    <td><div class="img-placeholder">IMG</div></td>
                    <td><strong>${p.nombre}</strong></td>
                    <td>${p.descripcion || '-'}</td>
                    <td class="price">$${p.precio}</td>
                    <td>
                        <button class="btn-delete" onclick="alert('Función pendiente')">Borrar</button>
                    </td>
                </tr>
            `;
        });
    }

    // Crear Producto
    async function crearProducto() {
        const nombre = document.getElementById('pNombre').value;
        const descripcion = document.getElementById('pDesc').value;
        const precio = document.getElementById('pPrecio').value;

        if(!nombre || !precio) return alert("Llena los datos");

        await fetch('/products', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ nombre, descripcion, precio })
        });
        cargarVista('productos');
    }

    // Eliminar Usuario
    async function eliminarUsuario(id) {
        if (!confirm('¿Seguro de eliminar este usuario?')) return;
        await fetch('/admin/users/' + id, { method: 'DELETE' });
        cargarVista(vistaActual);
    }

    // Crear Usuario (Cliente o Vendedor)
    async function crearUsuario(rolAsignado) {
        const nombre = document.getElementById('uNombre').value;
        const email = document.getElementById('uEmail').value;
        const password = document.getElementById('uPass').value;

        if(!nombre || !email || !password) return alert("Por favor completa todos los campos para crear");

        try {
            const res = await fetch('/admin/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    nombre: nombre, 
                    email: email, 
                    password: password, 
                    rol: rolAsignado 
                })
            });

            if(res.ok) {
                cargarVista(vistaActual);
            } else {
                const msg = await res.text();
                alert("Error: " + msg);
            }
        } catch (error) {
            console.error(error);
            alert("Error de conexión");
        }
    }

    // Inicializar
    document.querySelectorAll('.tab-btn')[0].click(); 
</script>






</body>
</html>