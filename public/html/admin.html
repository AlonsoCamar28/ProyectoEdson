<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin | Nova Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar scrolled">
    <div class="nav-content">
        <div class="logo">NOVA STORE <span style="color:var(--secondary); font-size:0.8em;">ADMIN</span></div>
        <ul class="nav-links">
            <li><a href="/">Ir a Tienda</a></li>
            <li><a href="/auth/logout" class="btn-nav">Cerrar Sesión</a></li>
        </ul>
    </div>
</nav>

<section class="admin-container">
    <div class="admin-header">
        <h2>Panel de Control</h2>
        <p>Administra tu negocio desde un solo lugar</p>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" onclick="cargarVista('clientes')">
            <i class="fa-solid fa-users"></i> Clientes
        </button>
        <button class="tab-btn" onclick="cargarVista('vendedores')">
            <i class="fa-solid fa-user-tie"></i> Vendedores
        </button>
        <button class="tab-btn" onclick="cargarVista('productos')">
            <i class="fa-solid fa-box-open"></i> Productos
        </button>
    </div>

    <div class="table-container">
        <div id="action-bar" class="action-bar"></div>

        <table class="data-table">
            <thead id="table-head">
                </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</section>

<script>
    // --- VARIABLES GLOBALES ---
    let vistaActual = 'clientes';
    let idSeleccionado = null; // Sirve para guardar el ID del Usuario o Producto que estamos editando

    // --- FUNCIÓN PRINCIPAL (ROUTER DEL FRONTEND) ---
    async function cargarVista(vista) {
        vistaActual = vista;
        limpiarFormulario(); // Reseteamos formularios y variables al cambiar de pestaña
        
        // 1. Actualizar estilos de las pestañas (Tabs)
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if(event && event.target) {
            const btn = event.target.closest('button');
            if(btn) btn.classList.add('active');
        }

        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const actionBar = document.getElementById('action-bar');
        
        // Mostrar estado de carga
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem;">Cargando datos...</td></tr>';
        actionBar.innerHTML = ''; 

        try {
            // ==========================================
            // CASO 1: CLIENTES O VENDEDORES
            // ==========================================
            if (vista === 'clientes' || vista === 'vendedores') {
                const rol = vista === 'clientes' ? 'cliente' : 'vendedor';

                // Inyectar Formulario de Usuarios
                actionBar.innerHTML = `
                    <div class="inline-form">
                        <input id="uNombre" placeholder="Nombre completo" />
                        <input id="uEmail" placeholder="Correo electrónico" />
                        <input id="uPass" type="password" placeholder="Contraseña" />
                        
                        <button class="btn-primary" onclick="crearUsuario('${rol}')">+ Agregar</button>
                        
                        <button id="btnUpdate" class="btn-primary" onclick="actualizarUsuario()" style="display:none; background-color: #f59e0b; margin-left:5px;">Actualizar</button>
                        <button id="btnCancel" class="btn-delete" onclick="limpiarFormulario()" style="display:none; margin-left:5px;">Cancelar</button>
                    </div>
                `;

                // Inyectar Encabezados
                const extraHeader = vista === 'vendedores' ? 'Ventas' : 'Rol';
                tableHead.innerHTML = `
                    <tr>
                        <th>ID</th><th>Nombre</th><th>Email</th><th>${extraHeader}</th><th>Acciones</th>
                    </tr>
                `;

                // Fetch y Renderizado
                const res = await fetch(`/admin/users?rol=${rol}`);
                const data = await res.json();
                renderUsers(data);

            // ==========================================
            // CASO 2: PRODUCTOS
            // ==========================================
            } else if (vista === 'productos') {
                
                // Inyectar Formulario de Productos
                actionBar.innerHTML = `
                    <div class="inline-form">
                        <input id="pNombre" placeholder="Nombre Producto" />
                        <input id="pDesc" placeholder="Descripción breve" />
                        <input id="pPrecio" type="number" placeholder="$ Precio" style="width:100px;" />
                        
                        <button class="btn-primary" onclick="crearProducto()">+ Agregar</button>

                        <button id="btnUpdateP" class="btn-primary" onclick="actualizarProducto()" style="display:none; background-color: #f59e0b; margin-left:5px;">Actualizar</button>
                        <button id="btnCancelP" class="btn-delete" onclick="limpiarFormulario()" style="display:none; margin-left:5px;">Cancelar</button>
                    </div>
                `;

                // Inyectar Encabezados
                tableHead.innerHTML = `
                    <tr>
                        <th>ID</th><th>Img</th><th>Producto</th><th>Descripción</th><th>Precio</th><th>Acciones</th>
                    </tr>
                `;
                
                // Fetch y Renderizado
                const res = await fetch('/products');
                const data = await res.json();
                renderProducts(data);
            }
        } catch (error) {
            console.error(error);
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error de conexión con el servidor</td></tr>';
        }
    }

    // --- FUNCIONES DE RENDERIZADO (DIBUJAR TABLAS) ---

    function renderUsers(users) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        
        if(users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay registros</td></tr>';
            return;
        }

        users.forEach(u => {
            // Convertimos objeto a string seguro para el HTML
            const userStr = JSON.stringify(u).replace(/'/g, "&#39;");

            tbody.innerHTML += `
                <tr onclick='seleccionarUsuario(${userStr})' style="cursor: pointer; transition: 0.2s;" title="Clic para editar">
                    <td>#${u.id}</td>
                    <td><div class="user-cell"><strong>${u.nombre}</strong></div></td>
                    <td>${u.email}</td>
                    <td><span class="badge ${u.rol}">${u.rol}</span></td>
                    <td>
                        <button class="btn-delete" onclick="event.stopPropagation(); eliminarUsuario(${u.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    function renderProducts(products) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        if(products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay productos</td></tr>';
            return;
        }

        products.forEach(p => {
            const prodStr = JSON.stringify(p).replace(/'/g, "&#39;");

            tbody.innerHTML += `
                <tr onclick='seleccionarProducto(${prodStr})' style="cursor: pointer; transition: 0.2s;" title="Clic para editar">
                    <td>#${p.id}</td>
                    <td><div style="background:#334155; color:#94a3b8; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:4px; font-size:0.7em;">IMG</div></td>
                    <td><strong>${p.nombre}</strong></td>
                    <td>${p.descripcion || '-'}</td>
                    <td class="price">$${p.precio}</td>
                    <td>
                        <button class="btn-delete" onclick="event.stopPropagation(); eliminarProducto(${p.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    // --- LÓGICA DE SELECCIÓN Y LIMPIEZA (PARA UPDATE) ---

    // 1. Rellenar inputs de USUARIO
    function seleccionarUsuario(user) {
        idSeleccionado = user.id;
        document.getElementById('uNombre').value = user.nombre;
        document.getElementById('uEmail').value = user.email;
        
        const passField = document.getElementById('uPass');
        passField.value = '';
        passField.placeholder = "Nueva contraseña (o dejar vacío)";

        // Mostrar botones de edición
        document.getElementById('btnUpdate').style.display = 'inline-block';
        document.getElementById('btnCancel').style.display = 'inline-block';
    }

    // 2. Rellenar inputs de PRODUCTO
    function seleccionarProducto(prod) {
        idSeleccionado = prod.id;
        document.getElementById('pNombre').value = prod.nombre;
        document.getElementById('pDesc').value = prod.descripcion;
        document.getElementById('pPrecio').value = prod.precio;

        // Mostrar botones de edición
        document.getElementById('btnUpdateP').style.display = 'inline-block';
        document.getElementById('btnCancelP').style.display = 'inline-block';
    }

    // 3. Limpiar Todo
    function limpiarFormulario() {
        idSeleccionado = null;

        // Limpiar campos Usuario (si existen)
        if(document.getElementById('uNombre')) {
            document.getElementById('uNombre').value = '';
            document.getElementById('uEmail').value = '';
            document.getElementById('uPass').value = '';
            document.getElementById('uPass').placeholder = "Contraseña";
            document.getElementById('btnUpdate').style.display = 'none';
            document.getElementById('btnCancel').style.display = 'none';
        }

        // Limpiar campos Producto (si existen)
        if(document.getElementById('pNombre')) {
            document.getElementById('pNombre').value = '';
            document.getElementById('pDesc').value = '';
            document.getElementById('pPrecio').value = '';
            document.getElementById('btnUpdateP').style.display = 'none';
            document.getElementById('btnCancelP').style.display = 'none';
        }
    }

    // --- OPERACIONES CRUD: USUARIOS ---

    async function crearUsuario(rolAsignado) {
        const nombre = document.getElementById('uNombre').value;
        const email = document.getElementById('uEmail').value;
        const password = document.getElementById('uPass').value;

        if(!nombre || !email || !password) return alert("Completa todos los campos");

        await fetch('/admin/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre, email, password, rol: rolAsignado })
        });
        cargarVista(vistaActual);
    }

    async function actualizarUsuario() {
        if(!idSeleccionado) return alert("Selecciona un usuario");
        
        const nombre = document.getElementById('uNombre').value;
        const email = document.getElementById('uEmail').value;
        const password = document.getElementById('uPass').value;
        const rol = vistaActual === 'clientes' ? 'cliente' : 'vendedor';

        const res = await fetch('/admin/users/' + idSeleccionado, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre, email, password, rol })
        });

        if(res.ok) {
            limpiarFormulario();
            cargarVista(vistaActual);
        } else {
            alert("Error al actualizar");
        }
    }

    async function eliminarUsuario(id) {
        if (!confirm('¿Seguro de eliminar este usuario?')) return;
        await fetch('/admin/users/' + id, { method: 'DELETE' });
        cargarVista(vistaActual);
    }

    // --- OPERACIONES CRUD: PRODUCTOS ---

    async function crearProducto() {
        const nombre = document.getElementById('pNombre').value;
        const descripcion = document.getElementById('pDesc').value;
        const precio = document.getElementById('pPrecio').value;

        if(!nombre || !precio) return alert("Nombre y Precio obligatorios");

        await fetch('/products', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ nombre, descripcion, precio })
        });
        cargarVista('productos');
    }

    async function actualizarProducto() {
        if(!idSeleccionado) return alert("Selecciona un producto");

        const nombre = document.getElementById('pNombre').value;
        const descripcion = document.getElementById('pDesc').value;
        const precio = document.getElementById('pPrecio').value;

        await fetch('/products/' + idSeleccionado, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ nombre, descripcion, precio })
        });

        limpiarFormulario();
        cargarVista('productos');
    }

    async function eliminarProducto(id) {
        if (!confirm('¿Seguro de borrar este producto?')) return;
        await fetch('/products/' + id, { method: 'DELETE' });
        cargarVista('productos');
    }

    // Inicializar app en la primera pestaña
    document.querySelectorAll('.tab-btn')[0].click(); 
</script>

</body>
</html>