<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin | Nova Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar scrolled">
    <div class="nav-content">
        <div class="logo">NOVA STORE <span style="color:var(--secondary); font-size:0.8em;">ADMIN</span></div>
        <ul class="nav-links">
            <li><a href="/">Ir a Tienda</a></li>
            <li><a href="/auth/logout" class="btn-nav">Cerrar Sesión</a></li>
        </ul>
    </div>
</nav>

<section class="admin-container">
    <div class="admin-header">
        <h2>Panel de Control</h2>
        <p>Administra tu negocio desde un solo lugar</p>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" onclick="cargarVista('clientes')">
            <i class="fa-solid fa-users"></i> Clientes
        </button>
        <button class="tab-btn" onclick="cargarVista('vendedores')">
            <i class="fa-solid fa-user-tie"></i> Vendedores
        </button>
        <button class="tab-btn" onclick="cargarVista('productos')">
            <i class="fa-solid fa-box-open"></i> Productos
        </button>
    </div>

    <div class="table-container">
        <div id="action-bar" class="action-bar"></div>

        <table class="data-table">
            <thead id="table-head">
                </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</section>

<script>
    // --- VARIABLES GLOBALES ---
    let vistaActual = 'clientes';
    let idSeleccionado = null; // Sirve para guardar el ID del Usuario o Producto que estamos editando

    // --- FUNCIÓN PRINCIPAL (ROUTER DEL FRONTEND) ---
    async function cargarVista(vista) {
        vistaActual = vista;
        limpiarFormulario(); // Reseteamos formularios y variables al cambiar de pestaña
        
        // 1. Actualizar estilos de las pestañas (Tabs)
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if(event && event.target) {
            const btn = event.target.closest('button');
            if(btn) btn.classList.add('active');
        }

        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const actionBar = document.getElementById('action-bar');
        
        // Mostrar estado de carga
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem;">Cargando datos...</td></tr>';
        actionBar.innerHTML = ''; 

        try {
            // ==========================================
            // CASO 1: CLIENTES O VENDEDORES
            // ==========================================
            if (vista === 'clientes' || vista === 'vendedores') {
                const rol = vista === 'clientes' ? 'cliente' : 'vendedor';

                // Inyectar Formulario de Usuarios
                actionBar.innerHTML = `
                    <div class="inline-form">
                        <input id="uNombre" placeholder="Nombre completo" />
                        <input id="uEmail" placeholder="Correo electrónico" />
                        <input id="uPass" type="password" placeholder="Contraseña" />
                        
                        <button class="btn-primary" onclick="crearUsuario('${rol}')">+ Agregar</button>
                        
                        <button id="btnUpdate" class="btn-primary" onclick="actualizarUsuario()" style="display:none; background-color: #f59e0b; margin-left:5px;">Actualizar</button>
                        <button id="btnCancel" class="btn-delete" onclick="limpiarFormulario()" style="display:none; margin-left:5px;">Cancelar</button>
                    </div>
                `;

                // Inyectar Encabezados
                const extraHeader = vista === 'vendedores' ? 'Ventas' : 'Rol';
                tableHead.innerHTML = `
                    <tr>
                        <th>ID</th><th>Nombre</th><th>Email</th><th>${extraHeader}</th><th>Acciones</th>
                    </tr>
                `;

                // Fetch y Renderizado
                const res = await fetch(`/admin/users?rol=${rol}`);
                const data = await res.json();
                renderUsers(data);


            // ==========================================
            // CASO 2: PRODUCTOS (ACTUALIZADO CON STOCK)
            // ==========================================
            } else if (vista === 'productos') {
                
                // Inyectar Formulario de Productos (AHORA CON INPUT DE STOCK)
               // Copia esto dentro de tu actionBar.innerHTML
                    actionBar.innerHTML = `
                        <div style="background:#334155; padding:15px; border-radius:8px; display:flex; gap:10px; align-items:flex-end; flex-wrap: wrap;">
                            
                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <input id="pNombre" placeholder="Nombre Producto" style="padding:8px; border-radius:4px; border:none;">
                                <input id="pDesc" placeholder="Descripción" style="padding:8px; border-radius:4px; border:none;">
                            </div>

                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <input id="pPrecio" type="number" placeholder="$ Precio" style="width:80px; padding:8px; border-radius:4px; border:none;">
                                <input id="pStock" type="number" placeholder="Stock" style="width:80px; padding:8px; border-radius:4px; border:none;">
                            </div>
                            
                            <div style="display:flex; flex-direction:column;">
                                <label style="color:white; font-size:0.8em; margin-bottom:2px;">Fotos (Max 5):</label>
                                <input type="file" id="pFotos" multiple accept="image/*" style="color:white; font-size:0.9em;">
                            </div>

                            <button class="btn-primary" onclick="crearProductoConFotos()">+ Publicar</button>
                            
                            <button id="btnUpdateP" class="btn-primary" onclick="actualizarProducto()" style="display:none; background-color: #f59e0b; margin-left:5px;">Actualizar Datos</button>
                            <button id="btnCancelP" class="btn-delete" onclick="limpiarFormulario()" style="display:none; margin-left:5px;">Cancelar</button>
                        </div>
                    `;

                // Inyectar Encabezados (AHORA CON COLUMNA STOCK)
                tableHead.innerHTML = `
                    <tr>
                        <th>ID</th>
                        <th>Img</th>
                        <th>Producto</th>
                        <th>Descripción</th>
                        <th>Precio</th>
                        <th>Stock</th> <th>Acciones</th>
                    </tr>
                `;
                
                // Fetch y Renderizado
                const res = await fetch('/products');
                const data = await res.json();
                renderProducts(data);
            }
        } catch (error) {
            console.error(error);
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error de conexión con el servidor</td></tr>';
        }
    }

    // --- FUNCIONES DE RENDERIZADO (DIBUJAR TABLAS) ---

    function renderUsers(users) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        
        if(users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay registros</td></tr>';
            return;
        }

        users.forEach(u => {
            // Convertimos objeto a string seguro para el HTML
            const userStr = JSON.stringify(u).replace(/'/g, "&#39;");

            tbody.innerHTML += `
                <tr onclick='seleccionarUsuario(${userStr})' style="cursor: pointer; transition: 0.2s;" title="Clic para editar">
                    <td>#${u.id}</td>
                    <td><div class="user-cell"><strong>${u.nombre}</strong></div></td>
                    <td>${u.email}</td>
                    <td><span class="badge ${u.rol}">${u.rol}</span></td>
                    <td>
                        <button class="btn-delete" onclick="event.stopPropagation(); eliminarUsuario(${u.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

   function renderProducts(products) { // O renderTable en vendedor.html
    const tbody = document.getElementById('table-body');
    const thead = document.getElementById('table-head'); // Aseguramos el encabezado correcto
    
    // Actualizamos el encabezado dinámicamente para asegurar que tenga Stock
    if(thead) {
        thead.innerHTML = `
            <tr>
                <th>ID</th>
                <th>Img</th>
                <th>Producto</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Stock</th> <th>Acciones</th>
            </tr>
        `;
    }

    tbody.innerHTML = '';

    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay productos</td></tr>';
        return;
    }

    products.forEach(p => {
        const prodStr = JSON.stringify(p).replace(/'/g, "&#39;");

        // Lógica visual: Si stock es menor a 5, ponerlo en rojo
        const stockStyle = p.stock < 5 ? 'color: #ef4444; font-weight: bold;' : 'color: #10b981;';
        const stockText = p.stock < 5 ? `${p.stock} (Bajo)` : p.stock;

        // Si el producto tiene galería, usamos la primera foto, si no, la default
        const imagenMostrar = (p.galeria && p.galeria.length > 0) ? p.galeria[0] : p.imagen;

        tbody.innerHTML += `
            <tr onclick='seleccionarProducto(${prodStr})' style="cursor: pointer; transition: 0.2s;" title="Clic para editar">
                <td>#${p.id}</td>
                <td>
                    <div style="width:40px; height:40px; overflow:hidden; border-radius:4px; background:#334155;">
                        <img src="${imagenMostrar}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='/img/default.png'">
                    </div>
                </td>
                <td><strong>${p.nombre}</strong></td>
                <td>${p.descripcion || '-'}</td>
                <td class="price">$${p.precio}</td>
                <td style="${stockStyle}">${stockText}</td>
                <td>
                    <button class="btn-delete" onclick="event.stopPropagation(); eliminarProducto(${p.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
}


    // --- LÓGICA DE SELECCIÓN Y LIMPIEZA (PARA UPDATE) ---

    // 1. Rellenar inputs de USUARIO
    function seleccionarProducto(prod) {
    idSeleccionado = prod.id;
    document.getElementById('pNombre').value = prod.nombre;
    document.getElementById('pDesc').value = prod.descripcion;
    document.getElementById('pPrecio').value = prod.precio;
    document.getElementById('pStock').value = prod.stock; // <--- Nuevo

    document.getElementById('btnUpdateP').style.display = 'inline-block';
    document.getElementById('btnCancelP').style.display = 'inline-block';
}

if(document.getElementById('pNombre')) {
    // ... (lo que ya tenías) ...
    document.getElementById('pStock').value = ''; // <--- Nuevo
}

    // 2. Rellenar inputs de PRODUCTO
    function seleccionarProducto(prod) {
        idSeleccionado = prod.id;
        document.getElementById('pNombre').value = prod.nombre;
        document.getElementById('pDesc').value = prod.descripcion;
        document.getElementById('pPrecio').value = prod.precio;

        // Mostrar botones de edición
        document.getElementById('btnUpdateP').style.display = 'inline-block';
        document.getElementById('btnCancelP').style.display = 'inline-block';
    }

    // 3. Limpiar Todo
    function limpiarFormulario() {
        idSeleccionado = null;

        // Limpiar campos Usuario (si existen)
        if(document.getElementById('uNombre')) {
            document.getElementById('uNombre').value = '';
            document.getElementById('uEmail').value = '';
            document.getElementById('uPass').value = '';
            document.getElementById('uPass').placeholder = "Contraseña";
            document.getElementById('btnUpdate').style.display = 'none';
            document.getElementById('btnCancel').style.display = 'none';
        }

        // Limpiar campos Producto (si existen)
        if(document.getElementById('pNombre')) {
            document.getElementById('pNombre').value = '';
            document.getElementById('pDesc').value = '';
            document.getElementById('pPrecio').value = '';
            document.getElementById('btnUpdateP').style.display = 'none';
            document.getElementById('btnCancelP').style.display = 'none';
        }
    }

    // --- OPERACIONES CRUD: USUARIOS ---

    async function crearUsuario(rolAsignado) {
        const nombre = document.getElementById('uNombre').value;
        const email = document.getElementById('uEmail').value;
        const password = document.getElementById('uPass').value;

        if(!nombre || !email || !password) return alert("Completa todos los campos");

        await fetch('/admin/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre, email, password, rol: rolAsignado })
        });
        cargarVista(vistaActual);
    }

    async function actualizarUsuario() {
        if(!idSeleccionado) return alert("Selecciona un usuario");
        
        const nombre = document.getElementById('uNombre').value;
        const email = document.getElementById('uEmail').value;
        const password = document.getElementById('uPass').value;
        const rol = vistaActual === 'clientes' ? 'cliente' : 'vendedor';

        const res = await fetch('/admin/users/' + idSeleccionado, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre, email, password, rol })
        });

        if(res.ok) {
            limpiarFormulario();
            cargarVista(vistaActual);
        } else {
            alert("Error al actualizar");
        }
    }

    async function eliminarUsuario(id) {
        if (!confirm('¿Seguro de eliminar este usuario?')) return;
        await fetch('/admin/users/' + id, { method: 'DELETE' });
        cargarVista(vistaActual);
    }

    // --- OPERACIONES CRUD: PRODUCTOS ---

// PEGAR ESTO DENTRO DE LAS ETIQUETAS <script> EN ADMIN.HTML

async function crearProductoConFotos() {
    const nombre = document.getElementById('pNombre').value;
    const descripcion = document.getElementById('pDesc').value;
    const precio = document.getElementById('pPrecio').value;
    const stock = document.getElementById('pStock').value;
    const fileInput = document.getElementById('pFotos');

    // Validaciones
    if(!nombre || !precio) return alert("Nombre y Precio requeridos");
    // Validación opcional: quitar si quieres permitir crear sin fotos
    // if(fileInput.files.length === 0) return alert("Debes seleccionar al menos una imagen");

    const formData = new FormData();
    formData.append('nombre', nombre);
    formData.append('descripcion', descripcion);
    formData.append('precio', precio);
    formData.append('stock', stock);

    // Agregamos cada archivo seleccionado
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('imagenes', fileInput.files[i]);
    }

    try {
        const res = await fetch('/products', {
            method: 'POST',
            body: formData 
        });

        if(res.ok) {
            alert("Producto creado exitosamente");
            // Recargar la vista actual (usa la variable global vistaActual)
            cargarVista(vistaActual); 
        } else {
            const errorTxt = await res.text();
            alert("Error al crear: " + errorTxt);
        }
    } catch (error) {
        console.error(error);
        alert("Error de conexión");
    }
}



  // Actualizar Producto
async function actualizarProducto() {
    if(!idSeleccionado) return alert("Selecciona un producto");

    const nombre = document.getElementById('pNombre').value;
    const descripcion = document.getElementById('pDesc').value;
    const precio = document.getElementById('pPrecio').value;
    const stock = document.getElementById('pStock').value; // <--- Nuevo

    await fetch('/products/' + idSeleccionado, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        // Enviamos stock
        body: JSON.stringify({ nombre, descripcion, precio, stock })
    });

    limpiarFormulario();
    cargarVista('productos');
}

    async function eliminarProducto(id) {
        if (!confirm('¿Seguro de borrar este producto?')) return;
        await fetch('/products/' + id, { method: 'DELETE' });
        cargarVista('productos');
    }

    // Inicializar app en la primera pestaña
    document.querySelectorAll('.tab-btn')[0].click(); 
</script>

</body>
</html>