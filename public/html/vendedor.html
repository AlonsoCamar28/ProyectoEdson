<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Vendedor | Nova Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

    <nav class="navbar scrolled">
        <div class="nav-content">
            <div class="logo">NOVA <span style="color:var(--secondary);">VENDEDOR</span></div>
            <ul class="nav-links">
                <li><span style="color:#94a3b8; font-size:0.9em;">Perfil Vendedor</span></li>
                <li><a href="/auth/logout" class="btn-nav">Salir</a></li>
            </ul>
        </div>
    </nav>

    <section class="admin-container"> <div class="admin-header">
            <h2>Gestión de Mis Productos</h2>
            <p>Visualiza tu catálogo o gestiona el inventario detallado.</p>
        </div>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="cargarVista('visual')">
                <i class="fa-solid fa-grid-2"></i> Catálogo Visual
            </button>
            <button class="tab-btn" onclick="cargarVista('tabla')">
                <i class="fa-solid fa-list"></i> Gestión (Tabla CRUD)
            </button>
        </div>

        <div class="table-container" style="background: transparent; padding: 0;">
            
            <div id="vista-visual" style="display: block;">
                <div class="catalog-grid" id="grid-cards">
                    </div>
            </div>

            <div id="vista-tabla" style="display: none; background: #1e293b; padding: 1.5rem; border-radius: 12px;">
                
                <div id="action-bar" class="action-bar" style="margin-bottom: 2rem;">
                    <div class="inline-form">
                        <input id="pNombre" placeholder="Nombre Producto" />
                        <input id="pDesc" placeholder="Descripción breve" />
                        <input id="pPrecio" type="number" placeholder="$ Precio" style="width:100px;" />
                        
                        <button class="btn-primary" onclick="crearProducto()">+ Agregar</button>
                        <button id="btnUpdate" class="btn-primary" onclick="actualizarProducto()" style="display:none; background-color: #f59e0b; margin-left:5px;">Actualizar</button>
                        <button id="btnCancel" class="btn-delete" onclick="limpiarFormulario()" style="display:none; margin-left:5px;">Cancelar</button>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Img</th>
                            <th>Producto</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>

        </div>
    </section>

    <script>
        let vistaActual = 'visual';
        let idSeleccionado = null;

        // Cargar vista inicial
        document.addEventListener('DOMContentLoaded', () => {
            cargarVista('visual');
        });

        async function cargarVista(vista) {
            vistaActual = vista;
            limpiarFormulario();

            // 1. Manejo de Pestañas (Visual vs Tabla)
            const visualDiv = document.getElementById('vista-visual');
            const tablaDiv = document.getElementById('vista-tabla');
            const tabs = document.querySelectorAll('.tab-btn');

            // Resetear clases activas
            tabs.forEach(t => t.classList.remove('active'));

            if (vista === 'visual') {
                visualDiv.style.display = 'block';
                tablaDiv.style.display = 'none';
                tabs[0].classList.add('active'); // Botón 1 activo
            } else {
                visualDiv.style.display = 'none';
                tablaDiv.style.display = 'block';
                tabs[1].classList.add('active'); // Botón 2 activo
            }

            // 2. Obtener Datos del Backend
            try {
                const res = await fetch('/products');
                const products = await res.json();

                // Renderizar según la vista
                if (vista === 'visual') {
                    renderCards(products);
                } else {
                    renderTable(products);
                }
            } catch (error) {
                console.error(error);
                alert("Error al cargar productos");
            }
        }

        // --- RENDERIZADO VISUAL (TARJETAS) ---
        function renderCards(products) {
            const container = document.getElementById('grid-cards');
            container.innerHTML = '';

            if (products.length === 0) {
                container.innerHTML = '<p style="color:white;">No hay productos en el catálogo.</p>';
                return;
            }

            products.forEach(p => {
                container.innerHTML += `
                    <div class="product-card">
                        <div class="card-img-top">
                            <i class="fa-solid fa-box"></i> </div>
                        <div class="card-body">
                            <h3 class="card-title">${p.nombre}</h3>
                            <p class="card-text">${p.descripcion || 'Sin descripción disponible.'}</p>
                            <div class="card-footer">
                                <span class="price-tag">$${p.precio}</span>
                                <span style="font-size:0.8rem; color:#94a3b8;">ID: #${p.id}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // --- RENDERIZADO TABLA (IGUAL QUE ADMIN) ---
        function renderTable(products) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" align="center">Sin productos</td></tr>';
                return;
            }

            products.forEach(p => {
                const prodStr = JSON.stringify(p).replace(/'/g, "&#39;");

                tbody.innerHTML += `
                    <tr onclick='seleccionarProducto(${prodStr})' style="cursor: pointer;" title="Clic para editar">
                        <td>#${p.id}</td>
                        <td>
                            <div style="background:#334155; color:#94a3b8; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:4px; font-size:0.7em;">IMG</div>
                        </td>
                        <td><strong>${p.nombre}</strong></td>
                        <td>${p.descripcion || '-'}</td>
                        <td style="color:var(--secondary); font-weight:bold;">$${p.precio}</td>
                        <td>
                            <button class="btn-delete" onclick="event.stopPropagation(); eliminarProducto(${p.id})">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- LÓGICA CRUD (Misma lógica que Admin) ---

        function seleccionarProducto(prod) {
            idSeleccionado = prod.id;
            document.getElementById('pNombre').value = prod.nombre;
            document.getElementById('pDesc').value = prod.descripcion;
            document.getElementById('pPrecio').value = prod.precio;

            document.getElementById('btnUpdate').style.display = 'inline-block';
            document.getElementById('btnCancel').style.display = 'inline-block';
        }

        function limpiarFormulario() {
            idSeleccionado = null;
            document.getElementById('pNombre').value = '';
            document.getElementById('pDesc').value = '';
            document.getElementById('pPrecio').value = '';
            
            document.getElementById('btnUpdate').style.display = 'none';
            document.getElementById('btnCancel').style.display = 'none';
        }

        async function crearProducto() {
            const nombre = document.getElementById('pNombre').value;
            const descripcion = document.getElementById('pDesc').value;
            const precio = document.getElementById('pPrecio').value;

            if(!nombre || !precio) return alert("Nombre y Precio obligatorios");

            await fetch('/products', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ nombre, descripcion, precio })
            });
            cargarVista('tabla');
        }

        async function actualizarProducto() {
            if(!idSeleccionado) return alert("Selecciona un producto");
            const nombre = document.getElementById('pNombre').value;
            const descripcion = document.getElementById('pDesc').value;
            const precio = document.getElementById('pPrecio').value;

            await fetch('/products/' + idSeleccionado, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ nombre, descripcion, precio })
            });
            limpiarFormulario();
            cargarVista('tabla');
        }

        async function eliminarProducto(id) {
            if(!confirm('¿Eliminar producto?')) return;
            await fetch('/products/' + id, { method: 'DELETE' });
            cargarVista('tabla');
        }
    </script>
</body>
</html>